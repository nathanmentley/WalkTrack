version: "3.9"
services:
  couchdb:
    container_name: couchdb
    image: couchdb:latest
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=password
    expose:
      - 5984
    ports:
      - "5984:5984"
    volumes:
      - couchdb:/opt/couchdb/data

  mssql:
    container_name: mssql
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD="${MSSQL_PASSWORD}"
      - MSSQL_PID=Express
    expose:
      - 1433
    ports:
      - "1433:1433"
    volumes:
      - mssql:/var/opt/mssql

  entryservice:
    container_name: entryservice
    build:
      context: .
      dockerfile: src/Server/EntryService/dockerfile
    environment:
    - JWT_SECRET="${JWT_SECRET}"
    expose:
    - 8001
    depends_on:
    - couchdb
    restart: unless-stopped

  goalservice:
    container_name: goalservice
    build:
      context: .
      dockerfile: src/Server/GoalService/dockerfile
    environment:
    - JWT_SECRET="${JWT_SECRET}"
    expose:
    - 8002
    depends_on:
    - couchdb
    restart: unless-stopped

  userservice:
    container_name: userservice
    build:
      context: .
      dockerfile: src/Server/UserService/dockerfile
    environment:
    - JWT_SECRET="${JWT_SECRET}"
    - ADMIN_USERNAME="${ADMIN_USERNAME}"
    - ADMIN_PASSWORD="${ADMIN_PASSWORD}"
    expose:
    - 8000
    depends_on:
    - couchdb
    - mssql
    restart: unless-stopped

  app:
    container_name: app
    build:
      context: .
      dockerfile: src/App/dockerfile
    expose:
    - 80
    depends_on:
    - entryservice
    - goalservice
    - userservice
    restart: unless-stopped

  proxy:
    container_name: proxy
    image: nginx:alpine
    volumes:
    - ./config/proxy/nginx.conf:/etc/nginx/nginx.conf
    ports:
    - "80:80"
    - "443:443"
    depends_on:
    - entryservice
    - goalservice
    - userservice
    - app
    restart: unless-stopped

volumes:
  couchdb:
    external: true
  mssql:
    external: true